<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Авторизация</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: Arial; max-width: 400px; margin: 0 auto; padding: 20px; }
        .step { display: none; }
        .active { display: block; }
        input, button { width: 100%; padding: 10px; margin: 5px 0; box-sizing: border-box; }
        button { background: #2481cc; color: white; border: none; }
        #timer { color: #666; text-align: center; }
    </style>
</head>
<body>
    <div id="step1" class="step active">
        <h2>Введите ваш email</h2>
        <input type="email" id="email" placeholder="example@etu.ru" required>
        <button onclick="sendCode()">Получить код</button>
    </div>

    <div id="step2" class="step">
        <h2>Введите код из email</h2>
        <input type="text" id="code" placeholder="6-значный код" required>
        <div id="timer">Код действителен: <span id="time">15:00</span></div>
        <button onclick="verifyCode()">Подтвердить</button>
        <button onclick="resendCode()" style="background: #666;">Отправить новый код</button>
    </div>

    <div id="status"></div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.enableClosingConfirmation();
        
        const API_BASE_URL = "https://ваш-сервер.ru"; // Замените на ваш URL
        let countdown = 15 * 60;
        let timerInterval;
        let currentEmail = "";

        function showStep(stepId) {
            document.querySelectorAll('.step').forEach(step => {
                step.classList.remove('active');
            });
            document.getElementById(stepId).classList.add('active');
        }

        function showStatus(message, isError = false) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.style.color = isError ? 'red' : 'green';
            statusDiv.style.display = 'block';
        }

        function startTimer() {
            clearInterval(timerInterval);
            countdown = 15 * 60;
            updateTimer();
            timerInterval = setInterval(updateTimer, 1000);
        }

        function updateTimer() {
            const minutes = Math.floor(countdown / 60);
            const seconds = countdown % 60;
            document.getElementById('time').textContent = 
                `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
            
            if (countdown <= 0) {
                clearInterval(timerInterval);
                document.getElementById('timer').textContent = 'Срок действия кода истек';
            }
            countdown--;
        }

        async function sendCode() {
            const email = document.getElementById('email').value;
            const telegramId = new URLSearchParams(window.location.search).get('user_id');

            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/send_code`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, telegram_id: telegramId })
                });

                const data = await response.json();
                
                if (response.ok) {
                    currentEmail = email;
                    showStep('step2');
                    startTimer();
                    showStatus('Код отправлен на ваш email');
                } else {
                    showStatus(data.message || 'Ошибка отправки кода', true);
                }
            } catch (error) {
                showStatus('Ошибка соединения с сервером', true);
            }
        }

        async function verifyCode() {
            const code = document.getElementById('code').value;
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/auth/verify_code`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: currentEmail, code })
                });

                const data = await response.json();
                
                if (response.ok) {
                    showStatus('Авторизация успешна!');
                    setTimeout(() => tg.close(), 2000);
                } else {
                    showStatus(data.message || 'Неверный код', true);
                }
            } catch (error) {
                showStatus('Ошибка соединения с сервером', true);
            }
        }

        function resendCode() {
            clearInterval(timerInterval);
            sendCode();
        }
    </script>
</body>
</html>
